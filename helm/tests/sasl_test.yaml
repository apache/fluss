#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

suite: sasl-disabled-secret
templates:
  - templates/secret-jaas-config.yaml
tests:
  - it: does not render sasl secret when sasl is disabled
    set:
      listeners.internal.protocol: PLAINTEXT
      listeners.client.protocol: PLAINTEXT
    asserts:
      - hasDocuments:
          count: 0
---

suite: sasl-disabled-statefulset
templates:
  - templates/sts-coordinator.yaml
tests:
  - it: does not render sasl settings in pod spec when sasl is disabled
    set:
      listeners.internal.protocol: PLAINTEXT
      listeners.client.protocol: PLAINTEXT
    asserts:
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'security\.sasl\.enabled\.mechanisms:'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'security\.sasl\.plain\.jaas\.config:'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.sasl\.username:'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.sasl\.password:'
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: sasl-config
---

suite: sasl-enabled-generated-secret
templates:
  - templates/secret-jaas-config.yaml
tests:
  - it: renders generated sasl secret when sasl is enabled
    set:
      listeners.internal.protocol: SASL_PLAINTEXT
      listeners.client.protocol: SASL_PLAINTEXT
    asserts:
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: ^RELEASE-NAME-fluss-sasl-jaas-config$
      - matchRegex:
          path: stringData["jaas.conf"]
          pattern: 'FlussServer\s*\{'
      - matchRegex:
          path: stringData["jaas.conf"]
          pattern: 'FlussClient\s*\{'
---

suite: sasl-enabled-secret-with-plaintext-internal
templates:
  - templates/secret-jaas-config.yaml
tests:
  - it: does not include FlussClient section when internal listener is not SASL
    set:
      listeners.internal.protocol: PLAINTEXT
      listeners.client.protocol: SASL_PLAINTEXT
    asserts:
      - hasDocuments:
          count: 1
      - matchRegex:
          path: stringData["jaas.conf"]
          pattern: 'FlussServer\s*\{'
      - notMatchRegex:
          path: stringData["jaas.conf"]
          pattern: 'FlussClient\s*\{'
---

suite: sasl-enabled-statefulset-uses-generated-secret
templates:
  - templates/sts-coordinator.yaml
tests:
  - it: references generated secret and wires JVM JAAS config
    set:
      listeners.internal.protocol: SASL_PLAINTEXT
      listeners.client.protocol: SASL_PLAINTEXT
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: sasl-config
            secret:
              secretName: RELEASE-NAME-fluss-sasl-jaas-config
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'FLUSS_ENV_JAVA_OPTS="-Djava\.security\.auth\.login\.config=/etc/fluss/conf/jaas\.conf \$\{FLUSS_ENV_JAVA_OPTS\}"'
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.protocol: SASL'
---

suite: sasl-enabled-statefulset-internal-plaintext
templates:
  - templates/sts-coordinator.yaml
  - templates/sts-tablet.yaml
tests:
  - it: does not render internal client sasl config for coordinator when internal listener is plaintext
    set:
      listeners.internal.protocol: PLAINTEXT
      listeners.client.protocol: SASL_PLAINTEXT
    template: templates/sts-coordinator.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'security\.sasl\.enabled\.mechanisms: PLAIN'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.protocol: SASL'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.sasl\.mechanism: PLAIN'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.sasl\.username:'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.sasl\.password:'
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'FLUSS_ENV_JAVA_OPTS="-Djava\.security\.auth\.login\.config=/etc/fluss/conf/jaas\.conf \$\{FLUSS_ENV_JAVA_OPTS\}"'
  - it: does not render internal client sasl config for tablet when internal listener is plaintext
    set:
      listeners.internal.protocol: PLAINTEXT
      listeners.client.protocol: SASL_PLAINTEXT
    template: templates/sts-tablet.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'security\.sasl\.enabled\.mechanisms: PLAIN'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.protocol: SASL'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.sasl\.mechanism: PLAIN'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.sasl\.username:'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'client\.security\.sasl\.password:'
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'FLUSS_ENV_JAVA_OPTS="-Djava\.security\.auth\.login\.config=/etc/fluss/conf/jaas\.conf \$\{FLUSS_ENV_JAVA_OPTS\}"'
---

suite: sasl-empty-users-fails
templates:
  - templates/secret-jaas-config.yaml
tests:
  - it: fails with clear message when sasl users are empty
    set:
      listeners.internal.protocol: SASL_PLAINTEXT
      listeners.client.protocol: SASL_PLAINTEXT
      security.sasl_plain.users: []
    asserts:
      - failedTemplate:
          errorMessage: security.sasl_plain.users must contain at least one user when SASL is enabled in listeners
---

suite: server-yaml-write-path
templates:
  - templates/sts-tablet.yaml
tests:
  - it: writes server yaml using expected destination path
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: cp /opt/conf/server\.yaml \$FLUSS_HOME/conf
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: '>> \$FLUSS_HOME/conf/server\.yaml'
---

suite: zookeeper-sasl-enabled-secret
templates:
  - templates/secret-jaas-config.yaml
tests:
  - it: renders zookeeper client JAAS block when zookeeper sasl is enabled
    set:
      listeners.internal.protocol: PLAINTEXT
      listeners.client.protocol: PLAINTEXT
      security.zookeeper_sasl.username: zk-username
      security.zookeeper_sasl.password: zk-password
    asserts:
      - hasDocuments:
          count: 1
      - matchRegex:
          path: stringData["jaas.conf"]
          pattern: 'ZookeeperClient\s*\{'
      - notMatchRegex:
          path: stringData["jaas.conf"]
          pattern: '^\s*Client\s*\{'
      - notMatchRegex:
          path: stringData["jaas.conf"]
          pattern: 'FlussServer\s*\{'
      - equal:
          path: stringData["zookeeper-client.properties"]
          value: |
            zookeeper.sasl.client=true
            zookeeper.sasl.clientconfig=ZookeeperClient
---

suite: zookeeper-sasl-enabled-statefulset
templates:
  - templates/sts-coordinator.yaml
tests:
  - it: wires jaas and zookeeper client config path for zookeeper sasl
    set:
      listeners.internal.protocol: PLAINTEXT
      listeners.client.protocol: PLAINTEXT
      security.zookeeper_sasl.username: zk-username
      security.zookeeper_sasl.password: zk-password
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: sasl-config
            secret:
              secretName: RELEASE-NAME-fluss-sasl-jaas-config
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'zookeeper\.client\.config-path: /etc/fluss/conf/zookeeper-client\.properties'
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'FLUSS_ENV_JAVA_OPTS="-Djava\.security\.auth\.login\.config=/etc/fluss/conf/jaas\.conf \$\{FLUSS_ENV_JAVA_OPTS\}"'
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'security\.sasl\.enabled\.mechanisms: PLAIN'
---

suite: zookeeper-sasl-missing-credentials-fails
templates:
  - templates/secret-jaas-config.yaml
tests:
  - it: fails when zookeeper sasl credentials are missing
    set:
      listeners.internal.protocol: PLAINTEXT
      listeners.client.protocol: PLAINTEXT
      security.zookeeper_sasl.username: zk-username
    asserts:
      - failedTemplate:
          errorMessage: security.zookeeper_sasl.username and security.zookeeper_sasl.password must be set together
